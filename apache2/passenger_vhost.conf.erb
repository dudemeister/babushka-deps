PassengerMinInstances 4
PassengerMaxPoolSize 10
PassengerUseGlobalQueue on

<VirtualHost *:80>

  ServerName <%= var(:server_name) %>
  DocumentRoot <%= var(:document_root) / 'current/public' %>

  ErrorLog <%= var(:document_root) / 'shared/log/error.log' %>
  CustomLog <%= var(:document_root) / 'shared/log/access.log' %> common
  
  ProxyRequests On
  AllowCONNECT  22
  
  <Proxy http://127.0.0.1:8124>
    AddDefaultCharset off
    Order deny,allow
    Allow from all
  </Proxy>

  <ProxyMatch http://127.0.0.1:8000>
    AddDefaultCharset off
    Order deny,allow
    Allow from all
  </ProxyMatch>

  <ProxyMatch http://127.0.0.1:2812>
    Order deny,allow
    Allow from all
  </ProxyMatch>

  <ProxyMatch localhost:22>
    Order deny,allow
    Allow from all
  </ProxyMatch>

  ProxyPass /node http://127.0.0.1:8124
  ProxyPassReverse /node http://127.0.0.1:8124

  ProxyPass /xhr http://127.0.0.1:8000
  ProxyPassReverse /xhr http://127.0.0.1:8000

  ProxyPass /monit/ http://127.0.0.1:2812/
  ProxyPassReverse /monit/ http://127.0.0.1:2812/

  XSendFile on
  XSendFilePath <%= var(:document_root) / 'shared/user-files' %>

  <IfModule mod_websocket_tcp_proxy.c>
    <Location /websocket>
      SetHandler websocket-handler
      WebSocketHandler  /usr/lib/apache2/modules/mod_websocket_tcp_proxy.so tcp_proxy_init
      WebSocketTcpProxyHost localhost
      WebSocketTcpProxyPort 5000
      SupportDraft75 On
    </Location>
  </IfModule>

  AddExternalAuth pwauth /usr/sbin/pwauth
  SetExternalAuthMethod pwauth pipe
  AddExternalGroup unixgroup /usr/local/bin/unixgroup
  SetExternalGroupMethod unixgroup environment

  RewriteEngine On
  RewriteCond %{LA-U:REMOTE_USER} ^[a-z].*
  RewriteRule ^\/dav\/(.*)$ /home/%{LA-U:REMOTE_USER}/$1

  <Directory /home>
      PassengerEnabled off
      Options Indexes MultiViews +FollowSymLinks
      AllowOverride All
      Order allow,deny
      allow from all
  </Directory>

  <Directory "/home/protonet">
    Options -Indexes +FollowSymLinks +MultiViews
    AllowOverride all
    Allow from all
    PassengerEnabled on
  </Directory>

  <Location /dav/>
      Dav on
      Options +Indexes +FollowSymLinks
      AuthType Basic
      AuthBasicProvider external
      AuthExternal pwauth
      GroupExternal unixgroup
      AuthName "protonet webDAV"
      Require group protonet
  </Location>

</VirtualHost>

<VirtualHost *:443>

  ServerName <%= var(:server_name) %>
  DocumentRoot <%= var(:document_root) / 'current/public' %>

  ErrorLog <%= var(:document_root) / 'shared/log/error.log' %>
  CustomLog <%= var(:document_root) / 'shared/log/access.log' %> common
  
  SSLEngine on
  SSLOptions +StrictRequire
  SSLProtocol all -SSLv2
  SSLCipherSuite ALL:!ADH:!EXPORT:!SSLv2:RC4+RSA:+HIGH:+MEDIUM

  SSLCACertificateFile <%= var(:document_root) / 'shared/config/protonet.d/ca.crt' %>
  SSLCertificateFile <%= var(:document_root) / 'shared/config/protonet.d/local.protonet.info.crt' %>
  SSLCertificateKeyFile <%= var(:document_root) / 'shared/config/protonet.d/local.protonet.info.key' %>
  SetEnvIf User-Agent ".*MSIE.*" nokeepalive ssl-unclean-shutdown
  
  <Location /system/files>
    Order deny,allow
    Allow from all
    Satisfy any
  </Location>

  ProxyRequests On
  AllowCONNECT  22
  
  <Proxy http://127.0.0.1:8124 >
    AddDefaultCharset off
    Order deny,allow
    Allow from all
  </Proxy>

  <ProxyMatch http://127.0.0.1:8000>
    AddDefaultCharset off
    Order deny,allow
    Allow from all
  </ProxyMatch>

  <ProxyMatch http://127.0.0.1:2812>
    Order deny,allow
    Allow from all
  </ProxyMatch>

  <ProxyMatch localhost:22>
    Order deny,allow
    Allow from all
  </ProxyMatch>

  ProxyPass /node http://127.0.0.1:8124
  ProxyPassReverse /node http://127.0.0.1:8124

  ProxyPass /xhr http://127.0.0.1:8000
  ProxyPassReverse /xhr http://127.0.0.1:8000

  ProxyPass /monit/ http://127.0.0.1:2812/
  ProxyPassReverse /monit/ http://127.0.0.1:2812/

  XSendFile on
  XSendFilePath <%= var(:document_root) / 'shared/user-files' %>

  <IfModule mod_websocket_tcp_proxy.c>
    <Location /websocket>
      SetHandler websocket-handler
      WebSocketHandler  /usr/lib/apache2/modules/mod_websocket_tcp_proxy.so tcp_proxy_init
      WebSocketTcpProxyHost localhost
      WebSocketTcpProxyPort 5000
      SupportDraft75 On
    </Location>
  </IfModule>

  AddExternalAuth pwauth /usr/sbin/pwauth
  SetExternalAuthMethod pwauth pipe
  AddExternalGroup unixgroup /usr/local/bin/unixgroup
  SetExternalGroupMethod unixgroup environment

  RewriteEngine On
  RewriteCond %{LA-U:REMOTE_USER} ^[a-z].*
  RewriteRule ^\/dav\/(.*)$ /home/%{LA-U:REMOTE_USER}/$1
  
  <Directory /home>
      PassengerEnabled off
      Options Indexes MultiViews +FollowSymLinks
      AllowOverride All
      Order allow,deny
      allow from all
  </Directory>

  <Directory "/home/protonet">
    Options -Indexes +FollowSymLinks +MultiViews
    AllowOverride all
    Allow from all
    PassengerEnabled on
  </Directory>

  <Location /dav/>
      Dav on
      Options +Indexes +FollowSymLinks
      AuthType Basic
      AuthBasicProvider external
      AuthExternal pwauth
      GroupExternal unixgroup
      AuthName "protonet webDAV"
      Require group protonet
  </Location>
</VirtualHost>
